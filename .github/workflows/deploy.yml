name: Deploy

on: workflow_dispatch
#  push:
#    branches:
#      - main

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ vars.ARCHODEX_SOURCE_DIR || ''}}
    steps:
      - name: Checkout code
        if: ${{ !env.ACT }}
        uses: actions/checkout@v4

      - name: Build with Cargo
        run: cargo lambda build --release --arm64 --package lambda --output-format zip

  upload:
    needs: build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ vars.ARCHODEX_SOURCE_DIR || ''}}
    strategy:
      matrix:
        region:
          - us-west-2
          - us-east-1
    steps:
      - name: Upload Lambda API function zip package to regional backend deployment asset buckets
        run: |-
          API_BOOTSTRAP_MD5SUM=$(md5sum target/lambda/lambda/bootstrap.zip | awk '{print $1}')
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

          aws s3 ls "s3://cloudformation-deployment-assets-${ACCOUNT_ID}-${{matrix.region}}/backend/api/bootstrap-${API_BOOTSTRAP_MD5SUM}.zip" > /dev/null
          if [ $? -eq 0 ]; then
            echo "Lambda API function zip package already exists in ${{matrix.region}} deployment asset bucket"
          else
            aws s3 cp --sse AES256 \
              target/lambda/lambda/bootstrap.zip \
              "s3://cloudformation-deployment-assets-${ACCOUNT_ID}-${{matrix.region}}/backend/api/bootstrap-${API_BOOTSTRAP_MD5SUM}.zip"
          fi          

  deploy:
    needs: upload
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ vars.ARCHODEX_SOURCE_DIR || ''}}
    steps:
      - name: Deploy CloudFormation stack
        run: |-
          API_BOOTSTRAP_MD5SUM=$(md5sum target/lambda/lambda/bootstrap.zip | awk '{print $1}')

          aws cloudformation create-change-set \
            --stack-name archodex-backend \
            --change-set-name "archodex-backend-$(date +%Y-%m-%dT%H-%M-%S%z)" \
            --template-body file://template.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameters "ParameterKey=APIBootstrapMD5Sum,ParameterValue=${API_BOOTSTRAP_MD5SUM}"